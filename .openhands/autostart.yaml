# OpenHands Autostart Configuration
# This file defines commands to run automatically when a conversation starts.
# Commands are executed in order before the agent begins.
#
# IMPORTANT: Use $APP_PORT_1 and $APP_PORT_2 environment variables for ports!
# These are dynamically allocated by the Docker runtime and exposed externally.
# Hardcoded ports (like 8011, 8012) won't be accessible from outside the container.

autostart:
  enabled: true
  commands:
    # 1. Install Python dependencies
    - name: "Install Python deps"
      command: "cd /workspace/project/agentrepo && poetry install --no-interaction"
      background: false
      timeout: 300

    # 2. Install Frontend dependencies
    - name: "Install Frontend deps"
      command: "cd /workspace/project/agentrepo/frontend && npm install"
      background: false
      timeout: 300

    # 3. Build Frontend (required for backend to start)
    - name: "Build Frontend"
      command: "cd /workspace/project/agentrepo/frontend && npm run build"
      background: false
      timeout: 300

    # 4. Install Playwright browsers (required for browser functionality)
    - name: "Install Playwright"
      command: "cd /workspace/project/agentrepo && PLAYWRIGHT_BROWSERS_PATH=/home/openhands/.cache/playwright poetry run playwright install chromium"
      background: false
      timeout: 300

    # 5. Start Backend on APP_PORT_1 (LOCAL runtime - no Docker needed)
    - name: "Start Backend"
      command: "cd /workspace/project/agentrepo && RUNTIME=local poetry run uvicorn openhands.server.listen:app --host 0.0.0.0 --port $APP_PORT_1"
      background: true

    # 6. Start Frontend dev server on APP_PORT_2
    - name: "Start Frontend Dev"
      command: "cd /workspace/project/agentrepo/frontend && VITE_BACKEND_HOST=0.0.0.0:$APP_PORT_1 npm run dev -- --port $APP_PORT_2 --host 0.0.0.0"
      background: true
